#!/bin/bash

set -ex

echo 'Debug::pkgProblemResolver "true";' >> /etc/apt/apt.conf.d/debug
mv /usr/sbin/invoke-rc.d /usr/sbin/invoke-rc.d.bak
ln -s /bin/true /usr/sbin/invoke-rc.d

# Back up extrausers, see us using it towards the end.
cp /usr/share/pam-configs/touch-extrausers /tmp/

apt-get remove -y \
  account-plugin-facebook \
  account-plugin-flickr \
  account-plugin-google \
  account-plugin-twitter \
  adwaita-icon-theme \
  humanity-icon-theme \
  suru-icon-theme \
  gnome-bluetooth \
  gnome-menus \
  indicator-bluetooth \
  indicator-keyboard \
  indicator-location \
  indicator-network \
  indicator-transfer \
  qtdeclarative5-ubuntu-contacts0.1 \
  qtdeclarative5-ubuntu-content1 \
  qtdeclarative5-ubuntu-telephony-phonenumber0.1 \
  qtdeclarative5-ubuntu-telephony0.1 \
  qtdeclarative5-ubuntu-ui-extras-browser-plugin \
  qtdeclarative5-ubuntu-ui-extras0.2 \
  qtdeclarative5-ubuntu-web-plugin \
  qtdeclarative5-ubuntuone1.0 \
  qtdeclarative5-usermetrics0.1 \
  qtubuntu-sensors \
  ubuntu-application-api2-test \
  ubuntu-application-api2-touch \
  ubuntu-download-manager \
  ubuntu-keyboard \
  ubuntu-location-provider-here \
  ubuntu-location-service-bin \
  ubuntu-mobile-icons \
  ubuntu-mono \
  ubuntu-push-client \
  ubuntu-system-settings \
  ubuntu-system-settings-online-accounts \
  ubuntu-touch-customization-hooks \
  ubuntu-touch-session \
  ubuntu-upload-manager \
  ubuntuone-client-data \
  unity-asset-pool \
  unity-control-center \
  unity-plugin-scopes \
  unity-scope-mediascanner2 \
  unity-settings-daemon \
  unity-system-compositor \
  unity8 \
  desktop-file-utils \
  ibus \
  nano \
  obex-data-server \
  openbox \
  qtmir-android \
  telephony-service \
  url-dispatcher \
  whoopsie \
  whoopsie-preferences \
  libaspell15 \
  libcanberra-gtk3-0 \
  libcheese-gtk23 \
  libcheese7 \
  libclutter-1.0-0 \
  libclutter-gst-2.0-0 \
  libclutter-gtk-1.0-0 \
  libcogl-pango20 \
  libcogl-path20 \
  libcogl20 \
  libcontent-hub0 \
  libcrack2 \
  libenchant1c2a \
  libfcitx-config4 \
  libfcitx-gclient0 \
  libfcitx-utils0 \
  libgnome-bluetooth11 \
  libgnome-desktop-3-10 \
  libgnome-menu-3-0 \
  libgnomekbd8 \
  libgtop2-10 \
  libharfbuzz-icu0 \
  libibus-1.0-5 \
  libjavascriptcoregtk-3.0-0 \
  liblightdm-gobject-1-0 \
  libnm-gtk0 \
  libpwquality-common \
  libpwquality1 \
  libubuntu-app-launch2 \
  libubuntu-application-api2 \
  libubuntu-download-manager-client0 \
  libubuntu-download-manager-common0 \
  libubuntu-location-service2 \
  libubuntu-upload-manager-common0 \
  libubuntuoneauth-2.0-0 \
  libunity-action-qt1 \
  libunity-api0 \
  libunity-control-center1 \
  libunity-protocol-private0 \
  libunity-scopes3 \
  libunity-settings-daemon1 \
  libunity9 \
  libwacom2 \
  libwebkitgtk-3.0-0 \
  libwebp5 \
  libxklavier16 \
  lightdm \
  myspell-ca myspell-es myspell-it myspell-pl myspell-pt-br myspell-pt-pt \
  language-pack-touch-ast language-pack-touch-bg language-pack-touch-bs language-pack-touch-ca language-pack-touch-cs language-pack-touch-da language-pack-touch-de language-pack-touch-el language-pack-touch-en language-pack-touch-es language-pack-touch-eu language-pack-touch-fi language-pack-touch-fr language-pack-touch-gd language-pack-touch-gl language-pack-touch-he language-pack-touch-hu language-pack-touch-id language-pack-touch-it language-pack-touch-ja language-pack-touch-ko language-pack-touch-lt language-pack-touch-lv language-pack-touch-ms language-pack-touch-nb language-pack-touch-nl language-pack-touch-oc language-pack-touch-pl language-pack-touch-pt language-pack-touch-ro language-pack-touch-ru language-pack-touch-sk language-pack-touch-sl language-pack-touch-sr language-pack-touch-sv language-pack-touch-tr language-pack-touch-ug language-pack-touch-uk language-pack-touch-zh-hans language-pack-touch-zh-hant
# Possibly relevant. At least relevant enough to not be removed for the time
# being.
#   apg \
#   system-image-common \
#   system-image-dbus \

apt-get -yf install
apt-get -y install software-properties-common
apt-add-repository -y ppa:plasma-phone/ppa
apt update
# Hybris
apt-get install -y \
  libhybris \
  libhybris-common1 \
  libhybris-test \
  libhybris-utils
apt-get install -y libandroid-properties1
apt-get install -y libhardware2
apt-get install -y libmedia1
# Foundation wiring we will need to work with ubuntu-touch tooling.
# This might also need parts of ubuntu-touch-session
apt-get install -y \
  ubuntu-touch-generic-initrd \
  ubuntu-touch-customization-hooks \
  system-image-common \
  system-image-dbus \
  apparmor
# More Foundation. In particular everything here is related to enabling
# the phablet user which is an extrausers user.
apt-get install -y \
  lxc-android-config \
  libnss-extrausers \
  libpam-modules \
  libpam-modules-bin
# KF5 Stack
apt-get install -y \
  konsole \
  kwin \
  plasma-phone-components \
  qtwayland5 \
  xwayland

apt-get -y clean

# Cleanup
rm -f /etc/apt/apt.conf.d/debug
mv /usr/sbin/invoke-rc.d.bak /usr/sbin/invoke-rc.d

# Add touch-extrausers. This is something done through ubuntu-touch-session but
# apparently this is required to actually enable NSS extrausers to work, which
# is a requirement for successful flashing as otherwise there is no phablet
# user.
mv /tmp/touch-extrausers /usr/share/pam-configs/touch-extrausers
pam-auth-update --package touch-extrausers

# mkdir /userdata
# touch /userdata/.writable_image
# touch /userdata/.adb_onlock
# setprop persist.service.ssh true || true
#
# echo -n "manual
# exec /usr/sbin/sshd -D -o PasswordAuthentication=yes" > ssh.override
